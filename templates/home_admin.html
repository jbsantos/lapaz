<!DOCTYPE html>
<html>

<head>
  <title>ETP DIGITAL</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Inclua o CSS do NProgress -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/progress.css') }}">
  <!-- Inclua o JavaScript do NProgress -->
  <script src="{{ url_for('static', filename='js/progress.js') }}"></script>
</head>

<body>

  {% extends admin_base_template %}

  {% block body %}
  <button onclick="window.location.href = '{{ url_for('index') }}'">Criar formulário ETP /IN 40 e 94</button>

  <div class="row">
    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">
      <h3>ETP DIGITAL /IN 40</h3>
      <!-- <div class="scrollable-content"> -->
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Processo</th>
            <th>Usuário</th>
            <th>Nome do ETP - Data e Hora</th>
            <th>Baixar PDF</th>
            <th>Baixar CSV</th>
            <th>Editar</th>
            <th>Exportar para<br> ComprasNet</th>
            <th>Excluir</th>

          </tr>
        </thead>
        <tbody class="scrollable-tbody">
          {% for etp in etp40 %}
          <tr>
            <td>{{etp.id}}</td>
            <td> Criador {{current_user.username}}</td>
            <td>ETP40_{{etp.date_created.strftime('%d/%m/%Y %H:%M:%S')}}</td>
            <td>
              <form action="{{ url_for('baixar_pdf') }}" method="POST">
                <input type="hidden" name="id_form" value="{{etp.id}}">
                <input type="hidden" name="status" value="editar">
                <button type="submit" class="btn btn-link invisible-button"><i class="fa fa-file-pdf-o fa-2x"
                    aria-hidden="true" class="style-icon "></i></button>
              </form>
            </td>
            <td>
              <form action="{{ url_for('gerar_csv') }}" method="POST">
                <input type="hidden" name="id_form" value="{{etp.id}}">
                <input type="hidden" name="status" value="editar">
                <button type="submit" class="btn btn-link invisible-button"><i class="fa fa-file-excel-o fa-2x"
                    aria-hidden="true" class="style-icon "></i></button>
              </form>
            </td>
            <td>
              <form action="{{ url_for('retomar_dados') }}" method="POST">
                <input type="hidden" name="id_form" value="{{etp.id}}">
                <input type="hidden" name="status" value="editar">
                <button type="submit" class="btn btn-link invisible-button"><i class="fa fa-pencil-square-o fa-2x"
                    aria-hidden="true" class="style-icon "></i></button>
              </form>
            </td>
            <td>
              <form action="#" method="POST">
                <input type="hidden" name="id_form" value="{{etp.id}}">
                <input type="hidden" name="status" value="1">
                <button type="button" class="btn-login btn btn-link invisible-button"><i
                    class="fa fa-external-link fa-2x" aria-hidden="true" class="style-icon "></i></button>
              </form>
            </td>
            <td>
              <form action="{{ url_for('deletar_etp40') }}" method="POST" class="delete-form">
                <input type="hidden" name="id_form" value="{{etp.id}}">
                <input type="hidden" name="status" value="editar">
                <button type="button" class="btn btn-link invisible-button delete-button"><i class="fa fa-trash fa-2x"
                  aria-hidden="true" class="style-icon "></i></button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- </div> -->

      <!-- Elemento da mensagem de carregamento -->
      <div id="loading-message" class="hidden">
        Carregando, por favor aguarde...
      </div>

      <h3>ETP DIGITAL TIC /IN 94</h3>
      <div class="scrollable-content">
        <table class="table table-striped table-hover scrollable-table">
          <thead>
            <tr>
              <th>Processo</th>
              <th>Usuário</th>
              <th>Nome do ETP - Data e Hora</th>
              <th>Baixar PDF</th>
              <th>Baixar CSV</th>
              <th>Editar</th>
              <th>Exportar para<br> ComprasNet</th>
              <th>Excluir</th>

            </tr>
          </thead>
          <tbody>
            {% for etp in etp94 %}
            <tr>
              <td>{{etp.id}}</td>
              <td> Criador {{current_user.username}}</td>
              <td>ETP94_{{etp.date_created.strftime('%d/%m/%Y %H:%M:%S')}}</td>

              <td>
                <form action="{{ url_for('baixar_pdf_94') }}" method="POST">
                  <input type="hidden" name="id_form" value="{{etp.id}}">
                  <input type="hidden" name="status" value="editar">
                  <button type="submit" class="btn btn-link invisible-button"><i class="fa fa-file-pdf-o fa-2x"
                      aria-hidden="true" class="style-icon "></i></button>
                </form>
              </td>
              <td>
                <form action="{{ url_for('gerar_csv_94') }}" method="POST">
                  <input type="hidden" name="id_form" value="{{etp.id}}">
                  <input type="hidden" name="status" value="editar">
                  <button type="submit" class="btn btn-link invisible-button"><i class="fa fa-file-excel-o fa-2x"
                      aria-hidden="true" class="style-icon "></i></button>
                </form>
              </td>
              <td>
                <form action="{{ url_for('retomar_dados_94') }}" method="POST">
                  <input type="hidden" name="id_form" value="{{etp.id}}">
                  <input type="hidden" name="status" value="editar">
                  <button type="submit" class="btn btn-link invisible-button"><i class="fa fa-pencil-square-o fa-2x"
                      aria-hidden="true" class="style-icon "></i></button>
                </form>
              </td>
              <td>
                <form action="#" method="POST">
                  <input type="hidden" name="id_form" value="{{etp.id}}">
                  <input type="hidden" name="status" value="2">
                  <button type="button" class="btn-login btn btn-link invisible-button"><i
                      class="fa fa-external-link fa-2x" aria-hidden="true" class="style-icon "></i></button>
                </form>
              </td>
              <td>
                <form action="{{ url_for('deletar_etp94') }}" method="POST" class="delete-form">
                  <input type="hidden" name="id_form" value="{{etp.id}}">
                  <input type="hidden" name="status" value="editar">
                  <button type="button" class="btn btn-link invisible-button delete-button"><i class="fa fa-trash fa-2x"
                    aria-hidden="true" class="style-icon "></i></button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

      </div>
    </div>
  </div>
  
  <script>
    // Função para mostrar a mensagem de carregamento e iniciar a barra de progresso
    function iniciarCarregamento() {
      const mensagem = document.getElementById('loading-message');
      mensagem.classList.remove('hidden');

    }

    // Função para ocultar a mensagem de carregamento e finalizar a barra de progresso
    function finalizarCarregamento() {
      const mensagem = document.getElementById('loading-message');

      mensagem.classList.add('hidden');

    }
    // Função para enviar o formulário de login
    function enviarFormulario() {
      const button = $(this); // Pega o botão que foi clicado
      const id_form = button.siblings('[name="id_form"]').val(); // Pega o valor do atributo "id_form"
      const etp = button.siblings('[name="status"]').val();

      // Formulario
      Swal.fire({
        title: 'Login',
        html: '<form id="login-form">' +
          '<input type="text" id="username" class="swal2-input" placeholder="Usuário">' +
          '<input type="password" id="password" class="swal2-input" placeholder="Senha">' +
          '</form>',
        focusConfirm: false,
        preConfirm: () => {
          const username = $('#username').val();
          const password = $('#password').val();

          // Iniciar a barra de progresso
          iniciarCarregamento();
          
          let link;
          if (etp === '1') {
            link = '/retomar_dados_import'; // Altere para o URL correto para etp === '1'
          } else if (etp === '2') {
            link = '/retomar_dados_import_94'; // Altere para o URL correto para etp === '2'
          }

          // Enviar os dados de login para o backend (app.py) usando AJAX
          $.ajax({
            url: link,
            method: 'POST',
            data: { username: username, password: password, id_form: id_form, etp: etp },// userAgent: userAgent }, // Envia o id_form também
            success: function (response) {

              // Se a autenticação for bem-sucedida, redireciona para a página do Selenium
              console.log ('Status', response.status, 'tag', response.tag)
              if (response.status === 'success') {
                finalizarCarregamento();
                if (response.tag === 'success') {
                  Swal.fire({
                    icon: 'success',
                    title: 'Importação Efetuada Com Sucesso',
                    html: `
                      <div style="font-size: 16px; max-height: 400px; overflow-y: auto; align: left; ">
                        Os dados informados foram encaminhados para o site do Comprasnet, como identificado no Rascunho N° ${response.retorno}.
                        <br> Solicitamos que verifique as etapas e coloque as informações complementares que faltam.
                      
                        ${etp === '1'
                        ? `<div style="color: red; text-align: left;">
                            Obs: Retorne as etapas a seguir no próprio site do COMPRASNET:
                            <ul>
                              <li>Iniciando com as Informações básicas do ETP</li>
                              <li>Informando a Área Requisitante</li>
                              <li>Declarando a Viabilidade</li>
                              <li>Responsáveis</li>
                            </ul>
                            <a href="https://www.comprasnet.gov.br/seguro/loginPortalUASG.asp" target="_blank"> Clique aqui para acessar o rascunho gerado no site ComprasNet</a>

                          </div> </div>`
                        : etp === '2'
                          ? `<div style="color: red; text-align: left;">
                            Obs: Retorne as etapas a seguir no próprio site do COMPRASNET:
                            <ul>
                              <li>Iniciando com as Informações básicas do ETP</li>
                              <li>Informando a Área Requisitante</li>
                              <li>Declarando a Viabilidade</li>
                              <li>Responsáveis</li>
                            </ul>
                            <a href="https://www.comprasnet.gov.br/seguro/loginPortalUASG.asp" target="_blank"> Clique aqui para acessar o rascunho gerado site ComprasNet</a>

                          </div> </div>`
                          : 'Mensagem padrão se etp não for 1 nem 2'
                      }
                    `
                  });

                  return;
                } else {
                  // Se a autenticação falhar,Porem o rascunho foi gerado
                  Swal.fire({
                    icon: 'warning',
                    title: 'Rascunho Gerado',
                    html: `
                      <div style="font-size: 16px; max-height: 400px; overflow-y: auto; align: left; ">
                        Houve uma inconsistencia ao enviar os dados para o site do Comprasnet, entretanto gerou o Rascunho N° ${response.retorno}.
                        <br> Solicitamos que verifique as etapas e coloque as informações complementares que faltam usando a opção edita do Comprasnet ou faça a inportação novamente 
                        e exclua o documento do rascunho gerado com a numeração citada acima.
                      
                      </div>`
                  });

                  return;
                }
              }
            },
            error: function (error) {
              finalizarCarregamento();
              // console.error('Erro ao enviar dados de login:', error);
              Swal.fire('Atenção', ' <div style="font-size: 16px; max-height: 400px; overflow-y: auto; align: left; ">O processo não foi finalizado, refazer a importação.</div>', 'warning');
            },
          });
        }
      });
    }

    // Adicionar o evento de clique aos botões de classe "btn-login"
    $('.btn-login').click(enviarFormulario);

    // Função para lidar com a exclusão
    function confirmarExclusao() {
      const button = $(this); // Pega o botão que foi clicado
      const id_form = button.siblings('[name="id_form"]').val(); // Pega o valor do atributo "id_form"

      // Exibir um pop-up de confirmação usando o Swal.fire
      Swal.fire({
        title: 'Tem certeza?',
        // text: 'Você deseja excluir este arquivo?',
        html: `<div style="font-size: 16px; max-height: 400px; overflow-y: auto; align: left; ">
                 Você deseja excluir este arquivo?
              </div>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar',
        // width: '600px', // Defina a largura desejada
      }).then((result) => {
        if (result.isConfirmed) {
          // Se o usuário confirmar, envie o formulário para a exclusão
          const form = button.closest('form'); // Encontra o formulário mais próximo
          form.submit();
        }
      });
    }

    // Adicionar o evento de clique aos botões de exclusão
    $('.delete-button').click(confirmarExclusao);

  </script>
  {% endblock %}

</body>

</html>